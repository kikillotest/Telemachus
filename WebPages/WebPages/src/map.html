<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>Carte</title>

  <link rel="stylesheet" href="jKSPWAPICore.css" />

  <link rel="stylesheet" href="https://js.arcgis.com/4.0/esri/css/main.css">
  <script src="https://js.arcgis.com/4.0/"></script>

  <script type="text/javascript" src="jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="jKSPWAPICore.js"></script>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>

  <script>
    require(
      [
        "esri/Map",
        "esri/views/SceneView",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/symbols/PictureMarkerSymbol",
        "esri/symbols/PointSymbol3D",
        "esri/symbols/IconSymbol3DLayer",
        "esri/symbols/ObjectSymbol3DLayer",
        "esri/geometry/Point",
        "dojo/domReady!"
      ],
      function(
        Map, SceneView, GraphicsLayer,
        Graphic,
        PictureMarkerSymbol,
        PointSymbol3D,
        IconSymbol3DLayer,
        ObjectSymbol3DLayer,
        Point
      ) {

        var map = new Map({
          basemap: "satellite"
        });

        var view = new SceneView({
          container: "viewDiv",
          map: map,
          constraints: {
            altitude: {
              max: 36000000000 // meters
            }
          }
        });

        var satelliteLayer = new GraphicsLayer();
        var satelliteTracks = new GraphicsLayer();
        map.addMany([satelliteLayer, satelliteTracks]);

        rawData = [[0]];

        var pod = new PictureMarkerSymbol({
          url: "/telemachus/pod.png",
          width: 32,
          height: 32
        });
        var template = {
          title: "{name}",
          content: "Surface velocity : {svel}",
        };
        var redDot = new PointSymbol3D({
          symbolLayers: [new IconSymbol3DLayer({
            size: 16,  // points
            resource: { 
              primitive: "kite"
              //,href: "/telemachus/pod.png"
            },
            material: { color: "grey" },
            outline: { color: "white" }
          })]
        });

        jKSPWAPI.initPoll(
          "longs=v.long&lat=v.lat&name=v.name&alt=v.altitude&m=v.surfaceVelocity",
          function (rawData) {},
          function (rawData, d) {
            if (!isNaN(d.lat) && !isNaN(d.longs)) {

              var graphic = new Graphic({
                geometry: new Point(d.longs, d.lat, d.alt),
                symbol: redDot,
                attributes: {
                  name: d.name,
                  svel: d.m
                },
                popupTemplate: template
              });

              satelliteLayer.removeAll();
              satelliteLayer.add(graphic);
            }
          },
          rawData
        );
      }
    );
  </script>

</head>
<body>
  <div id="viewDiv"></div>
</body>
</html>
